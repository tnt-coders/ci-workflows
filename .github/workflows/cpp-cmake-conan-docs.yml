name: C++ CMake Conan Docs

on:
  workflow_call:

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
      - name: Setup
        uses: tnt-coders/ci-workflows/.github/actions/cpp-cmake-conan-setup@master

      - name: Install docs tools (Linux)
        shell: bash
        run: |
          sudo apt-get install -y doxygen graphviz

      - name: Configure
        run: cmake --preset release

      - name: Build docs
        run: cmake --build --preset release --target docs

      - name: Verify docs output
        shell: bash
        run: |
          test -d build/release/docs/html

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: doxygen-html
          path: build/release/docs/html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/release/docs/html

  check-publish:
    needs: docs
    runs-on: ubuntu-latest

    outputs:
      publish: ${{ steps.check-publish.outputs.publish }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Check if docs should publish
        id: check-publish
        shell: bash
        run: |
          LATEST=$(git tag --list 'v*' | sort -V | grep -vE '-' | tail -1)
          if [[ -z "$LATEST" ]]; then
            # No stable tags — publish on master push
            if [[ "$GITHUB_REF" == "refs/heads/master" ]]; then
              echo "publish=true" >> "$GITHUB_OUTPUT"
            else
              echo "publish=false" >> "$GITHUB_OUTPUT"
            fi
          else
            # Stable tags exist — only publish if this push is the latest stable tag
            if [[ "$GITHUB_REF" == "refs/tags/v$LATEST" ]]; then
              echo "publish=true" >> "$GITHUB_OUTPUT"
            else
              echo "publish=false" >> "$GITHUB_OUTPUT"
            fi
          fi

  publish:
    if: needs.check-publish.outputs.publish == 'true'
    needs: [docs, check-publish]
    runs-on: ubuntu-latest

    concurrency:
      group: github-pages
      cancel-in-progress: false

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.publish.outputs.page_url }}

    steps:
      - name: Publish to GitHub Pages
        id: publish
        uses: actions/deploy-pages@v4
