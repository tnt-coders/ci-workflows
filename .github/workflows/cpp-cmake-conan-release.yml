name: C++ CMake Conan Release

on:
  workflow_call:

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Download all package artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages
          pattern: packages-*
          merge-multiple: true

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            tag="${{ github.ref_name }}"
            gh release create "$tag" \
              --draft \
              --generate-notes \
              --title "$tag" \
              packages/*
          else
            gh release delete "dev-build" --yes 2>/dev/null || true
            gh api "repos/${{ github.repository }}/git/refs/tags/dev-build" -X DELETE 2>/dev/null || true

            gh release create "dev-build" \
              --draft \
              --title "Development Build" \
              --notes "Automated development build from commit ${{ github.sha }}" \
              --target "${{ github.sha }}" \
              packages/*
          fi
